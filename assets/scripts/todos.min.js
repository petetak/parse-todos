$(function(){Parse.$=jQuery,Parse.initialize("","");var e=Parse.Object.extend("Todo",{defaults:{content:"empty todo...",done:!1},initialize:function(){this.get("content")||this.set({content:this.defaults.content})},toggle:function(){this.save({done:!this.get("done")})}}),t=Parse.Object.extend("AppState",{defaults:{filter:"all"}}),n=Parse.Collection.extend({model:e,done:function(){return this.filter(function(e){return e.get("done")})},remaining:function(){return this.without.apply(this,this.done())},nextOrder:function(){return this.length?this.last().get("order")+1:1},comparator:function(e){return e.get("order")}}),i=Parse.View.extend({tagName:"li",template:_.template($("#item-template").html()),events:{"click .toggle":"toggleDone","dblclick label.todo-content":"edit","click .todo-destroy":"clear","keypress .edit":"updateOnEnter","blur .edit":"close"},initialize:function(){_.bindAll(this,"render","close","remove"),this.model.bind("change",this.render),this.model.bind("destroy",this.remove)},render:function(){return $(this.el).html(this.template(this.model.toJSON())),this.input=this.$(".edit"),this},toggleDone:function(){this.model.toggle()},edit:function(){$(this.el).addClass("editing"),this.input.focus()},close:function(){this.model.save({content:this.input.val()}),$(this.el).removeClass("editing")},updateOnEnter:function(e){13==e.keyCode&&this.close()},clear:function(){this.model.destroy()}}),s=Parse.View.extend({statsTemplate:_.template($("#stats-template").html()),events:{"keypress #new-todo":"createOnEnter","click #clear-completed":"clearCompleted","click #toggle-all":"toggleAllComplete","click .log-out":"logOut","click ul#filters a":"selectFilter"},el:".content",initialize:function(){_.bindAll(this,"addOne","addAll","addSome","render","toggleAllComplete","logOut","createOnEnter"),this.$el.html(_.template($("#manage-todos-template").html())),this.input=this.$("#new-todo"),this.allCheckbox=this.$("#toggle-all")[0],this.todos=new n,this.todos.query=new Parse.Query(e),this.todos.query.equalTo("user",Parse.User.current()),this.todos.bind("add",this.addOne),this.todos.bind("reset",this.addAll),this.todos.bind("all",this.render),this.todos.fetch(),a.on("change",this.filter,this)},logOut:function(){Parse.User.logOut(),new o,this.undelegateEvents(),delete this},render:function(){var e=this.todos.done().length,t=this.todos.remaining().length;this.$("#todo-stats").html(this.statsTemplate({total:this.todos.length,done:e,remaining:t})),this.delegateEvents(),this.allCheckbox.checked=!t},selectFilter:function(e){var t=$(e.target),n=t.attr("id");a.set({filter:n}),Parse.history.navigate(n)},filter:function(){var e=a.get("filter");this.$("ul#filters a").removeClass("selected"),this.$("ul#filters a#"+e).addClass("selected"),"all"===e?this.addAll():"completed"===e?this.addSome(function(e){return e.get("done")}):this.addSome(function(e){return!e.get("done")})},resetFilters:function(){this.$("ul#filters a").removeClass("selected"),this.$("ul#filters a#all").addClass("selected"),this.addAll()},addOne:function(e){var t=new i({model:e});this.$("#todo-list").append(t.render().el)},addAll:function(){this.$("#todo-list").html(""),this.todos.each(this.addOne)},addSome:function(e){var t=this;this.$("#todo-list").html(""),this.todos.chain().filter(e).each(function(e){t.addOne(e)})},createOnEnter:function(e){13==e.keyCode&&(this.todos.create({content:this.input.val(),order:this.todos.nextOrder(),done:!1,user:Parse.User.current(),ACL:new Parse.ACL(Parse.User.current())}),this.input.val(""),this.resetFilters())},clearCompleted:function(){return _.each(this.todos.done(),function(e){e.destroy()}),!1},toggleAllComplete:function(){var e=this.allCheckbox.checked;this.todos.each(function(t){t.save({done:e})})}}),o=Parse.View.extend({events:{"submit form.login-form":"logIn","submit form.signup-form":"signUp"},el:".content",initialize:function(){_.bindAll(this,"logIn","signUp"),this.render()},logIn:function(){var e=this,t=this.$("#login-username").val(),n=this.$("#login-password").val();return Parse.User.logIn(t,n,{success:function(){new s,e.undelegateEvents(),delete e},error:function(){e.$(".login-form .error").html("Invalid username or password. Please try again.").show(),e.$(".login-form button").removeAttr("disabled")}}),this.$(".login-form button").attr("disabled","disabled"),!1},signUp:function(){var e=this,t=this.$("#signup-username").val(),n=this.$("#signup-password").val();return Parse.User.signUp(t,n,{ACL:new Parse.ACL},{success:function(){new s,e.undelegateEvents(),delete e},error:function(t,n){e.$(".signup-form .error").html(n.message).show(),e.$(".signup-form button").removeAttr("disabled")}}),this.$(".signup-form button").attr("disabled","disabled"),!1},render:function(){this.$el.html(_.template($("#login-template").html())),this.delegateEvents()}}),l=Parse.View.extend({el:$("#todoapp"),initialize:function(){this.render()},render:function(){Parse.User.current()?new s:new o}}),r=Parse.Router.extend({routes:{all:"all",active:"active",completed:"completed"},initialize:function(){},all:function(){a.set({filter:"all"})},active:function(){a.set({filter:"active"})},completed:function(){a.set({filter:"completed"})}}),a=new t;new r,new l,Parse.history.start()});